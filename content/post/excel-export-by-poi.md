+++
title = "excel export by poi"
date = "2016-07-31T20:54:41+08:00"
tags = ["poi"]
categories = ["programming"]
menu = ""
banner = "banners/writing-desk.png"
+++

It's a online optimization for Excel export which might be a common demand, I will demonstrate the resolve thoughts , concrete problems , abstraction and the final result in this post.
<!--more-->

## Background

Recently,I've been accepted a task from my boss about the excel export from our sites. The problem is summarized into two major problems as followed:

- The download is slow.
- Sometimes it will cause the JVM to crash.

## Process

After digging into the code ,I've found we used the `poi` lib from `Apache`, and there were some serious issues where were confronted with:

- JPA query,As for the high-level abstracted ORM tools,that may be a common problem ,the domain-driven code for database query.which may result in too many database queries.bingo, that's where we were.
- we used `XSSFWorkbook` class to create the Excel sheet,which carried all the objects in memory that will cause `OOM` when the excel is too large.

## Concrete Problems

###  SQL
As for JPA ,it is a wrapper of Hibernate which do generate all the SQL behind,you can reduce your focus on the business domain and logic.but sometimes it will not be a good choice to use it in a simple way.
for example,if there's a table(table `A`) in the database ,and a column as another table's id(table `B`). at the same time, you abstract the two into an Entity and a field. which can be expressed as followed:

```
 class B{
    private A xxx
 }
 class A{
 }
```
in this way, the JPA will do the query sent from B as a sequence of :
```
 1. query from table B ,filter all the columns by relevant conditions.
 2. query from table A by id ,from the above queries result.
```
for queries like this,small amount of query ,it will be acceptable.But when the queried rows from the 1st query reaches some quantity,the interaction between the application server and the database will cause performance problems.

###   POI
`POI` is a mature lib from Apache. but for different demand ,there can be different implementations for excel generation.

- HSSF , for the Excel '97(-2007) file format.
- XSSF,  for the Excel 2007 OOXML (.xlsx) file format ,which uses XML as the underground implementation as the excel archive.
- SXSSF, compatible with the XSSF,but SXSSF achieves its low memory footprint by limiting access to the rows that are within a sliding window, while XSSF gives access to all rows in the document. Older rows that are no longer in the window become inaccessible, as they are written to the disk.
apparently ,from the display above,we can draw a safe conclusion: ** we should use SXSSF **, because we didn't know how much rows it will be generated by limited queries,we must limit the memory access for safety.


## Resolve

- Replace all the ORM query with `native sql` to accelerate the SQL query speed.which may not be that handy for ORM mapping tool.but as for speed, it is an overwhelming winner for `SQL` to ORM.
- use the `SXSSWorkbook` as an replacement for `XSSFWorkbook` which will reduce the memory footprint dramatically.




## Further More
- Isolate the excel server with other servers.As is known ,The excel process will generate a large amount of temp objects,which will affect the online performance that will result in latency of other online request. so Isolation is a good choice. Which can be down in some ways:



	- configure universal URI for excels,then you can configure the PROXY at the NGINX layer to specified machines.
	- configure a sub-domain,then as for the URL,you can write as `//subdomain/xxx`(don't touch the protocol,the browser will adapt it no matter it is http or https),you just modify the domain of the request URL. and configure the subdomain proxy at the NGINX.


- a little improvement by object sharing. for our export,there will be many Date object .I do some object sharing in the request by a `HashMap`,I can get a formatted Date String by a `Get` but not a `FastDateFormat` which will be much faster and reduce the memory footprint.

## Result
The Excel can be generated and exported into client in a short period. And with the isolation with other online servers,we can ignore the impact by the excel-export to our online business and the latency.

## Tips

- Don't forget to invoke poi's `dispose` after the whole process. Otherwise,there will be a lot of temp files on your server.
- Prepare the excel header row in advance which is better for speed.
